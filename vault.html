<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cloud Health Record Vault</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: {
              50: '#f6f7f9', 100: '#eef0f4', 200: '#dfe3ea', 300: '#c9cfdb',
              400: '#aab3c1', 500: '#8b97a8', 600: '#6b788a', 700: '#515d6e',
              800: '#364253', 900: '#1f2b3a'
            },
            accent: {
              500: '#0f62fe', 600: '#0b5adf', 700: '#0948ad'
            },
            success: { 600: '#0e8a00' },
            danger: { 600: '#da1e28' }
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.08)' },
          borderRadius: { xl2: '1.25rem' }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://esm.sh" />
</head>
<body class="min-h-screen bg-ink-50 text-ink-900">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-ink-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-lg bg-accent-500"></div>
        <div>
          <h1 class="text-xl font-semibold tracking-tight">Cloud Health Record Vault</h1>
          <p class="text-xs text-ink-600 -mt-0.5">Provider-agnostic • Patient self-access</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="userBadge" class="hidden text-sm text-ink-700"></span>
        <button id="loginBtn" class="px-4 py-2 rounded-lg bg-ink-900 text-white hover:bg-ink-800">Sign in with Google</button>
        <button id="logoutBtn" class="hidden px-4 py-2 rounded-lg border border-ink-300 text-ink-800 hover:bg-ink-100">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-white via-ink-50 to-ink-100"></div>
    <div class="max-w-6xl mx-auto px-4 py-10 relative">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <h2 class="text-3xl md:text-4xl font-semibold leading-tight text-ink-900">
            Your health records, unified. Secure. Always available.
          </h2>
          <p class="mt-3 text-ink-700">
            Upload lab reports, prescriptions, scans, and share time-limited links with doctors. Built on Supabase free tier.
          </p>
          <div class="mt-5 flex gap-3">
            <a href="#vault" class="px-4 py-2 rounded-lg bg-accent-500 text-white hover:bg-accent-600">Open Vault</a>
            <a href="#features" class="px-4 py-2 rounded-lg border border-ink-300 hover:bg-white">Learn more</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Vault -->
  <main id="vault" class="max-w-6xl mx-auto px-4 pb-16 space-y-8">
    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Upload Card -->
      <section class="lg:col-span-2 rounded-xl2 shadow-soft bg-white border border-ink-100">
        <div class="p-5 border-b border-ink-100 flex items-center justify-between">
          <h3 class="text-lg font-semibold">Upload health records</h3>
          <span id="quotaNote" class="text-xs text-ink-600">Free tier • Keep under 1GB</span>
        </div>
        <div class="p-5 space-y-4">
          <div class="flex flex-col md:flex-row md:items-center gap-3">
            <input id="fileInput" type="file" multiple class="block w-full text-sm text-ink-800 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-ink-900 file:text-white hover:file:bg-ink-800" />
            <button id="uploadBtn" class="px-4 py-2 rounded-lg bg-accent-500 text-white hover:bg-accent-600">Upload</button>
          </div>
          <div id="progressWrap" class="hidden">
            <div class="h-2 w-full bg-ink-100 rounded-full overflow-hidden">
              <div id="progressBar" class="h-2 bg-accent-500 w-0"></div>
            </div>
            <p id="progressText" class="mt-1 text-xs text-ink-700">Preparing…</p>
          </div>
        </div>
      </section>

      <!-- Filters -->
      <aside class="rounded-xl2 shadow-soft bg-white border border-ink-100 p-5 space-y-4">
        <h3 class="text-lg font-semibold">Find files</h3>
        <input id="searchInput" type="text" placeholder="Search by name…" class="w-full rounded-lg border border-ink-200 px-3 py-2" />
        <select id="typeFilter" class="w-full rounded-lg border border-ink-200 px-3 py-2">
          <option value="all">All types</option>
          <option value="pdf">PDF</option>
          <option value="image">Images</option>
          <option value="doc">DOC/DOCX</option>
          <option value="other">Other</option>
        </select>
      </aside>
    </div>

    <!-- Files List -->
    <section class="rounded-xl2 shadow-soft bg-white border border-ink-100">
      <div class="p-5 border-b border-ink-100 flex items-center justify-between">
        <h3 class="text-lg font-semibold">My files</h3>
        <span id="fileCount" class="text-sm text-ink-700"></span>
      </div>
      <div id="filesContainer" class="p-2 divide-y divide-ink-100"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="border-t border-ink-100 bg-white">
    <div class="max-w-6xl mx-auto px-4 py-8 text-xs text-ink-600">
      Built on Supabase free tier. Keep PHI safe: do not upload sensitive data unless your region and policies allow. You control access and deletion.
    </div>
  </footer>

  <!-- Supabase Logic -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = "https://zmozpigwpfiibykixdjk.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptb3pwaWd3cGZpaWJ5a2l4ZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDg1NDAsImV4cCI6MjA3MDgyNDU0MH0.kgMCNatoRbIhnzTNF3TDuf_edrHOt4rVMcGnPtXPwFI"
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // UI
    const loginBtn=document.getElementById('loginBtn')
    const logoutBtn=document.getElementById('logoutBtn')
    const userBadge=document.getElementById('userBadge')
    const fileInput=document.getElementById('fileInput')
    const uploadBtn=document.getElementById('uploadBtn')
    const progressWrap=document.getElementById('progressWrap')
    const progressBar=document.getElementById('progressBar')
    const progressText=document.getElementById('progressText')
    const filesContainer=document.getElementById('filesContainer')
    const fileCount=document.getElementById('fileCount')
    const searchInput=document.getElementById('searchInput')
    const typeFilter=document.getElementById('typeFilter')

    let currentUser=null, allFiles=[]

    loginBtn.onclick=async()=>{
      await supabase.auth.signInWithOAuth({
        provider:'google',
        options:{redirectTo:window.location.href}
      })
    }
    logoutBtn.onclick=async()=>{
      await supabase.auth.signOut()
      currentUser=null; updateHeader(); renderFiles([])
    }
    supabase.auth.onAuthStateChange(async(_,session)=>{
      currentUser=session?.user||null
      updateHeader(); if(currentUser) await loadFiles()
    })
    function updateHeader(){
      if(currentUser){
        userBadge.textContent=`Signed in as ${currentUser.email}`
        userBadge.classList.remove('hidden')
        loginBtn.classList.add('hidden')
        logoutBtn.classList.remove('hidden')
      } else {
        userBadge.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        logoutBtn.classList.add('hidden')
      }
    }

    uploadBtn.onclick=async()=>{
      const files=fileInput.files
      if(!currentUser) return alert('Please sign in first.')
      if(!files.length) return alert('Choose file(s).')

      progressWrap.classList.remove('hidden')
      progressBar.style.width='0%'
      progressText.textContent=`Uploading ${files.length}…`

      let uploaded=0
      for(const f of files){
        const path=`${currentUser.id}/${Date.now()}_${f.name}`
        const {error:upErr}=await supabase.storage.from('health-records').upload(path,f)
        if(upErr){alert('Upload error: '+upErr.message);continue}
        await supabase.from('files').insert({user_id:currentUser.id,name:f.name,size:f.size,path})
        uploaded++
        progressBar.style.width=(uploaded/files.length*100)+'%'
        progressText.textContent=`Uploaded ${uploaded}/${files.length}`
      }
      fileInput.value=''
      setTimeout(()=>progressWrap.classList.add('hidden'),800)
      await loadFiles()
    }

    async function loadFiles(){
      const {data,error}=await supabase.from('files').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false})
      if(error) return console.error(error)
      allFiles=data||[]; renderFiles(allFiles)
    }
    function extToType(name){
      const n=name.toLowerCase()
      if(n.endsWith('.pdf')) return 'pdf'
      if(n.match(/\.(jpg|jpeg|png|webp)$/)) return 'image'
      if(n.match(/\.(doc|docx)$/)) return 'doc'
      return 'other'
    }
    function renderFiles(list){
      const q=(searchInput.value||'').toLowerCase()
      const filter=typeFilter.value
      const filtered=list.filter(f=>{
        const t=extToType(f.name)
        return (filter==='all'||t===filter)&&f.name.toLowerCase().includes(q)
      })
      filesContainer.innerHTML=''
      fileCount.textContent=`${filtered.length} file(s)`
      if(!filtered.length){filesContainer.innerHTML='<div class="p-6 text-ink-600 text-sm">No files found.</div>';return}
      for(const f of filtered){
        const row=document.createElement('div')
        row.className='flex items-center justify-between p-3 hover:bg-ink-50'
        row.innerHTML=`
          <div>
            <div class="font-medium">${f.name}</div>
            <div class="text-xs text-ink-600">${(f.size/1024).toFixed(1)} KB • ${new Date(f.created_at).toLocaleString()}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn-open px-3 py-1.5 bg-ink-900 text-white rounded">Open</button>
            <button class="btn-copy px-3 py-1.5 border border-ink-300 rounded">Copy</button>
            <button class="btn-del px-3 py-1.5 bg-danger-600 text-white rounded">Delete</button>
          </div>`
        filesContainer.appendChild(row)
        row.querySelector('.btn-open').onclick=async()=>{
          const {data}=await supabase.storage.from('health-records').createSignedUrl(f.path,3600)
          if(data?.signedUrl) window.open(data.signedUrl,'_blank')
        }
        row.querySelector('.btn-copy').onclick=async()=>{
          const {data}=await supabase.storage.from('health-records').createSignedUrl(f.path,3600)
          if(data?.signedUrl){await navigator.clipboard.writeText(data.signedUrl);alert('Link copied')}
        }
        row.querySelector('.btn-del').onclick=async()=>{
          if(!confirm('Delete?')) return
          await supabase.storage.from('health-records').remove([f.path])
          await supabase.from('files').delete().eq('id',f.id)
          allFiles=allFiles.filter(x=>x.id!==f.id); renderFiles(allFiles)
        }
      }
    }
    searchInput.oninput=()=>renderFiles(allFiles)
    typeFilter.onchange=()=>renderFiles(allFiles)
    ;(async()=>{const {data:{session}}=await supabase.auth.getSession();currentUser=session?.user||null;updateHeader();if(currentUser) await loadFiles()})()
  </script>
</body>
</html>
