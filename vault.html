<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vault | Cloud Health Records</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: "#0f172a",
            light: "#f1f5f9",
            accent: { 500: "#0f62fe", 600: "#0b5adf" },
            danger: { 600: "#da1e28" },
          },
          boxShadow: {
            glass: "0 8px 32px rgba(0,0,0,0.37)",
          },
          backdropBlur: { lg: "blur(16px)" },
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-dark to-gray-900 text-light">

  <!-- Header -->
  <header class="flex justify-between items-center px-6 py-4 border-b border-gray-800 bg-dark/80 backdrop-blur-lg shadow-glass">
    <h1 class="text-xl font-bold">Vault</h1>
    <div class="flex items-center gap-3">
      <span id="userBadge" class="hidden text-sm"></span>
      <button id="loginBtn" class="px-4 py-2 rounded-lg bg-accent-500 hover:bg-accent-600 text-white">Login with Google</button>
      <button id="logoutBtn" class="hidden px-4 py-2 rounded-lg border border-gray-600 hover:bg-gray-700">Logout</button>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-4 py-10 space-y-8">

    <!-- Upload Section -->
    <section class="rounded-xl bg-white/5 backdrop-blur-lg border border-gray-700 shadow-glass p-6">
      <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
        <h3 class="text-lg font-semibold">Upload health records</h3>
        <span class="text-xs text-gray-400">Free tier • Keep under 1GB</span>
      </div>

      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <input id="fileInput" type="file" multiple
          class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg 
                 file:border-0 file:font-semibold file:bg-accent-500 file:text-white 
                 hover:file:bg-accent-600" />
        <button id="uploadBtn" class="px-4 py-2 rounded-lg bg-accent-500 text-white hover:bg-accent-600">
          Upload
        </button>
      </div>

      <div id="progressWrap" class="hidden mt-4">
        <div class="h-2 w-full bg-gray-700 rounded-full overflow-hidden">
          <div id="progressBar" class="h-2 bg-accent-500 w-0"></div>
        </div>
        <p id="progressText" class="mt-2 text-xs text-gray-300">Preparing…</p>
      </div>
    </section>

    <!-- Filters -->
    <section class="rounded-xl bg-white/5 backdrop-blur-lg border border-gray-700 shadow-glass p-6">
      <h3 class="text-lg font-semibold">Find files</h3>
      <input id="searchInput" type="text" placeholder="Search by name…" 
        class="w-full mt-3 rounded-lg border border-gray-600 bg-dark/60 px-3 py-2 focus:ring-2 focus:ring-accent-500" />
      <select id="typeFilter" 
        class="w-full mt-3 rounded-lg border border-gray-600 bg-dark/60 px-3 py-2 focus:ring-2 focus:ring-accent-500">
        <option value="all">All types</option>
        <option value="pdf">PDF</option>
        <option value="image">Images</option>
        <option value="doc">DOC/DOCX</option>
        <option value="other">Other</option>
      </select>
    </section>

    <!-- Files List -->
    <section class="rounded-xl bg-white/5 backdrop-blur-lg border border-gray-700 shadow-glass">
      <div class="flex justify-between items-center p-5 border-b border-gray-700">
        <h3 class="text-lg font-semibold">My files</h3>
        <span id="fileCount" class="text-sm text-gray-300"></span>
      </div>
      <div id="filesContainer" class="p-4 divide-y divide-gray-700"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-800 bg-dark/80 backdrop-blur-lg shadow-glass text-center py-6 text-xs text-gray-400">
    Built on Supabase free tier. Share links expire in 1 hour.
  </footer>

  <!-- App Script -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // Replace with your Supabase values
    const SUPABASE_URL = "https://zmozpigwpfiibykixdjk.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptb3pwaWd3cGZpaWJ5a2l4ZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDg1NDAsImV4cCI6MjA3MDgyNDU0MH0.kgMCNatoRbIhnzTNF3TDuf_edrHOt4rVMcGnPtXPwFI"

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // Refs
    const loginBtn = document.getElementById("loginBtn")
    const logoutBtn = document.getElementById("logoutBtn")
    const userBadge = document.getElementById("userBadge")
    const fileInput = document.getElementById("fileInput")
    const uploadBtn = document.getElementById("uploadBtn")
    const progressWrap = document.getElementById("progressWrap")
    const progressBar = document.getElementById("progressBar")
    const progressText = document.getElementById("progressText")
    const filesContainer = document.getElementById("filesContainer")
    const fileCount = document.getElementById("fileCount")
    const searchInput = document.getElementById("searchInput")
    const typeFilter = document.getElementById("typeFilter")

    let currentUser = null
    let allFiles = []

    // Auth
    loginBtn.addEventListener("click", async () => {
      const redirectTo = window.location.href
      await supabase.auth.signInWithOAuth({ provider: "google", options: { redirectTo } })
    })

    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut()
      currentUser = null
      updateHeader()
      renderFiles([])
    })

    supabase.auth.onAuthStateChange(async (_, session) => {
      currentUser = session?.user || null
      updateHeader()
      if (currentUser) await loadFiles()
    })

    function updateHeader() {
      if (currentUser) {
        userBadge.textContent = `Signed in as ${currentUser.email}`
        userBadge.classList.remove("hidden")
        loginBtn.classList.add("hidden")
        logoutBtn.classList.remove("hidden")
      } else {
        userBadge.classList.add("hidden")
        loginBtn.classList.remove("hidden")
        logoutBtn.classList.add("hidden")
      }
    }

    // Upload
    uploadBtn.addEventListener("click", async () => {
      const files = fileInput.files
      if (!currentUser) return alert("Please sign in first.")
      if (!files.length) return alert("Choose file(s) first.")

      progressWrap.classList.remove("hidden")
      progressBar.style.width = "0%"
      progressText.textContent = `Uploading ${files.length} file(s)…`

      let uploaded = 0
      for (const f of files) {
        const path = `${currentUser.id}/${Date.now()}_${f.name}`
        const { error: upErr } = await supabase.storage.from("health-records").upload(path, f)
        if (upErr) { alert("Upload error: " + upErr.message); continue }

        await supabase.from("files").insert({
          user_id: currentUser.id, name: f.name, size: f.size, path
        })
        uploaded++
        const pct = Math.round((uploaded / files.length) * 100)
        progressBar.style.width = pct + "%"
        progressText.textContent = `Uploaded ${uploaded}/${files.length}`
      }

      fileInput.value = ""
      setTimeout(()=> progressWrap.classList.add("hidden"), 600)
      await loadFiles()
    })

    // Load files
    async function loadFiles() {
      const { data, error } = await supabase.from("files")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false })
      if (error) return console.error(error)
      allFiles = data || []
      renderFiles(allFiles)
    }

    function extToType(name) {
      const n = name.toLowerCase()
      if (n.endsWith(".pdf")) return "pdf"
      if (n.match(/\.(jpg|jpeg|png|webp)$/)) return "image"
      if (n.match(/\.(doc|docx)$/)) return "doc"
      return "other"
    }

    function humanKB(bytes) {
      if (bytes < 1024) return bytes + " B"
      const kb = bytes / 1024
      if (kb < 1024) return kb.toFixed(1) + " KB"
      return (kb/1024).toFixed(1) + " MB"
    }

    function renderFiles(list) {
      const q = (searchInput.value || "").toLowerCase()
      const filter = typeFilter.value
      const filtered = list.filter(f => {
        const t = extToType(f.name)
        return (filter==="all" || t===filter) && f.name.toLowerCase().includes(q)
      })

      filesContainer.innerHTML = ""
      fileCount.textContent = `${filtered.length} file(s)`

      if (!filtered.length) {
        filesContainer.innerHTML = `<div class="p-4 text-gray-400">No files found.</div>`
        return
      }

      for (const f of filtered) {
        const row = document.createElement("div")
        row.className = "flex items-center justify-between py-3 px-2 hover:bg-white/5"
        row.innerHTML = `
          <div class="min-w-0">
            <div class="font-medium truncate">${f.name}</div>
            <div class="text-xs text-gray-400">${humanKB(f.size)} • ${new Date(f.created_at).toLocaleString()}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn-open px-3 py-1.5 rounded bg-accent-500 text-white text-sm" data-path="${f.path}">Open</button>
            <button class="btn-copy px-3 py-1.5 rounded border border-gray-600 text-sm" data-path="${f.path}">Copy link</button>
            <button class="btn-del px-3 py-1.5 rounded bg-danger-600 text-white text-sm" data-id="${f.id}" data-path="${f.path}">Delete</button>
          </div>
        `
        filesContainer.appendChild(row)
      }

      // Buttons
      document.querySelectorAll(".btn-open").forEach(btn => btn.onclick = async e => {
        const path = e.target.dataset.path
        const { data } = await supabase.storage.from("health-records").createSignedUrl(path, 3600)
        if (data?.signedUrl) window.open(data.signedUrl, "_blank")
      })
      document.querySelectorAll(".btn-copy").forEach(btn => btn.onclick = async e => {
        const path = e.target.dataset.path
        const { data } = await supabase.storage.from("health-records").createSignedUrl(path, 3600)
        if (data?.signedUrl) {
          await navigator.clipboard.writeText(data.signedUrl)
          alert("Link copied (valid 1h)")
        }
      })
      document.querySelectorAll(".btn-del").forEach(btn => btn.onclick = async e => {
        const id = e.target.dataset.id, path = e.target.dataset.path
        if (!confirm("Delete file?")) return
        await supabase.storage.from("health-records").remove([path])
        await supabase.from("files").delete().eq("id", id)
        allFiles = allFiles.filter(x => x.id !== id)
        renderFiles(allFiles)
      })
    }

    // Search + filter
    searchInput.oninput = () => renderFiles(allFiles)
    typeFilter.onchange = () => renderFiles(allFiles)

    // Init session
    (async () => {
      const { data: { session } } = await supabase.auth.getSession()
      currentUser = session?.user || null
      updateHeader()
      if (currentUser) await loadFiles()
    })()
  </script>
</body>
</html>
