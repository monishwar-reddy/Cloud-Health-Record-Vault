<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vault | Health Records</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 to-indigo-900 text-white min-h-screen">

  <!-- Header -->
  <header class="flex justify-between items-center px-6 py-4 bg-slate-800/80">
    <h1 class="text-xl font-bold">HealthVault</h1>
    <div class="flex items-center gap-3">
      <span id="userBadge" class="hidden text-sm"></span>
      <button id="logoutBtn" class="hidden px-4 py-2 rounded-lg border border-gray-500 hover:bg-gray-700">Logout</button>
    </div>
  </header>

  <!-- Upload Section -->
  <main class="max-w-4xl mx-auto px-6 py-10">
    <h2 class="text-2xl font-semibold mb-4">Upload Health Records</h2>
    <div class="flex gap-3 mb-6">
      <input id="fileInput" type="file" multiple class="block w-full text-sm text-black px-3 py-2 rounded-lg" />
      <button id="uploadBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500">Upload</button>
    </div>
    <div id="progressWrap" class="hidden">
      <div class="h-2 bg-gray-700 rounded overflow-hidden">
        <div id="progressBar" class="h-2 bg-blue-500 w-0"></div>
      </div>
      <p id="progressText" class="mt-2 text-xs text-gray-300">Preparingâ€¦</p>
    </div>

    <!-- File List -->
    <h3 class="text-xl font-semibold mt-10 mb-3">My Files</h3>
    <div id="filesContainer" class="space-y-3"></div>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ðŸ”¹ Replace with your Supabase values
    const SUPABASE_URL = "https://zmozpigwpfiibykixdjk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptb3pwaWd3cGZpaWJ5a2l4ZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDg1NDAsImV4cCI6MjA3MDgyNDU0MH0.kgMCNatoRbIhnzTNF3TDuf_edrHOt4rVMcGnPtXPwFI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const progressWrap = document.getElementById("progressWrap");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const filesContainer = document.getElementById("filesContainer");
    const logoutBtn = document.getElementById("logoutBtn");
    const userBadge = document.getElementById("userBadge");

    let currentUser = null;
    let allFiles = [];

    // ðŸ”¹ Check login
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user || null;
      if (!currentUser) {
        window.location.href = "index.html"; // redirect if not logged in
      } else {
        userBadge.textContent = `Signed in as ${currentUser.email}`;
        userBadge.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        await loadFiles();
      }
    })();

    // ðŸ”¹ Logout
    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "index.html";
    });

    // ðŸ”¹ Upload files
    uploadBtn.addEventListener("click", async () => {
      const files = fileInput.files;
      if (!files.length) return alert("Choose files first!");

      progressWrap.classList.remove("hidden");
      let uploaded = 0;

      for (const f of files) {
        const path = `${currentUser.id}/${Date.now()}_${f.name}`;
        const { error: upErr } = await supabase.storage
          .from("health-records")  // bucket name must exist in Supabase
          .upload(path, f);

        if (upErr) {
          alert("Upload failed: " + upErr.message);
          console.error(upErr);
          continue;
        }

        await supabase.from("files").insert({
          user_id: currentUser.id,
          name: f.name,
          size: f.size,
          path
        });

        uploaded++;
        const pct = Math.round((uploaded / files.length) * 100);
        progressBar.style.width = pct + "%";
        progressText.textContent = `Uploaded ${uploaded}/${files.length}`;
      }

      fileInput.value = "";
      setTimeout(() => progressWrap.classList.add("hidden"), 1000);
      await loadFiles();
    });

    // ðŸ”¹ Load file list
    async function loadFiles() {
      const { data, error } = await supabase
        .from("files")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) return console.error(error);
      allFiles = data || [];
      renderFiles();
    }

    function renderFiles() {
      filesContainer.innerHTML = "";
      if (!allFiles.length) {
        filesContainer.innerHTML = `<p class="text-gray-400">No files uploaded yet.</p>`;
        return;
      }

      for (const f of allFiles) {
        const row = document.createElement("div");
        row.className = "flex justify-between items-center bg-slate-800 px-4 py-2 rounded";
        row.innerHTML = `
          <div>
            <p class="font-medium">${f.name}</p>
            <p class="text-xs text-gray-400">${(f.size/1024).toFixed(1)} KB</p>
          </div>
          <button class="btn-open px-3 py-1 rounded bg-blue-600 text-white text-sm" data-path="${f.path}">Open</button>
        `;
        filesContainer.appendChild(row);
      }

      document.querySelectorAll(".btn-open").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const path = e.target.dataset.path;
          const { data } = await supabase.storage
            .from("health-records")
            .createSignedUrl(path, 3600);
          if (data?.signedUrl) window.open(data.signedUrl, "_blank");
        });
      });
    }
  </script>
</body>
</html>
