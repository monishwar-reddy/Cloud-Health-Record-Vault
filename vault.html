<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vault</title>
  <style>
  body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(-45deg, #141e30, #243b55, #141e30, #243b55);
  background-size: 400% 400%;
  animation: gradientBG 10s ease infinite;
  color: #f4f4f4;
  padding: 40px;
}

@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

h1 {
  text-align: center;
  margin-bottom: 30px;
  font-size: 2.2rem;
  font-weight: bold;
  letter-spacing: 1px;
  color: #ffffff;
  text-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

/* Authentication buttons */
#loginBtn, #logoutBtn {
  display: inline-block;
  margin: 10px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 25px;
  background: linear-gradient(135deg, #00c6ff, #0072ff);
  color: white;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  transition: all 0.2s ease;
}
.btn:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 12px rgba(0,0,0,0.4);
}

/* File card */
.file-card {
  background: rgba(255,255,255,0.07);
  border-radius: 12px;
  padding: 15px 20px;
  margin: 12px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255,255,255,0.15);
}
.file-card strong {
  font-size: 1rem;
}
.file-card small {
  font-size: 0.75rem;
  color: #ccc;
}

/* Inputs */
input[type="file"], 
input[type="text"], 
select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.08);
  color: #fff;
  margin-right: 8px;
}
input::placeholder {
  color: #aaa;
}

/* Progress bar */
#progressWrap {
  margin-top: 15px;
}
#progressBar {
  height: 8px;
  border-radius: 4px;
  background: linear-gradient(90deg, #00c6ff, #0072ff);
  transition: width 0.3s ease;
}
#progressText {
  font-size: 0.85rem;
  margin-top: 4px;
  color: #ddd;
}
  </style>
</head>
<body>
 <h1>Vault</h1>
  <div class="card">
    <!-- Authentication -->
    <div style="margin-bottom:20px;">
      <button id="loginBtn" class="btn">Login with Google</button>
      <button id="logoutBtn" class="btn hidden">Logout</button>
      <span id="userBadge" class="hidden"></span>
    </div>

    <!-- File Upload -->
    <div>
      <input type="file" id="fileInput" multiple>
      <button id="uploadBtn" class="btn">Upload</button>
    </div>

    <!-- Progress bar -->
    <div id="progressWrap" class="hidden">
      <div id="progressBar"></div>
      <p id="progressText"></p>
    </div>

    <!-- Search + filter -->
    <div style="margin-top:20px;">
      <input type="text" id="searchInput" placeholder="Search files…">
      <select id="typeFilter">
        <option value="all">All</option>
        <option value="pdf">PDF</option>
        <option value="image">Image</option>
        <option value="doc">Doc</option>
      </select>
    </div>

    <!-- File list -->
    <div id="fileCount" style="margin-top:15px;"></div>
    <div id="filesContainer"></div>
  </div>

  <!-- Supabase Script -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // TODO: Replace with your Supabase project values
    const SUPABASE_URL = 'https://zmozpigwpfiibykixdjk.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptb3pwaWd3cGZpaWJ5a2l4ZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDg1NDAsImV4cCI6MjA3MDgyNDU0MH0.kgMCNatoRbIhnzTNF3TDuf_edrHOt4rVMcGnPtXPwFI'
 const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // Refs
    const loginBtn = document.getElementById('loginBtn')
    const logoutBtn = document.getElementById('logoutBtn')
    const userBadge = document.getElementById('userBadge')
    const fileInput = document.getElementById('fileInput')
    const uploadBtn = document.getElementById('uploadBtn')
    const progressWrap = document.getElementById('progressWrap')
    const progressBar = document.getElementById('progressBar')
    const progressText = document.getElementById('progressText')
    const filesContainer = document.getElementById('filesContainer')
    const fileCount = document.getElementById('fileCount')
    const searchInput = document.getElementById('searchInput')
    const typeFilter = document.getElementById('typeFilter')

    let currentUser = null
    let allFiles = []

    // Login
    loginBtn.addEventListener('click', async () => {
      const redirectTo = window.location.origin + window.location.pathname
      await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo } })
    })

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut()
      currentUser = null
      updateHeader()
      renderFiles([])
    })

    supabase.auth.onAuthStateChange(async (_, session) => {
      currentUser = session?.user || null
      updateHeader()
      if (currentUser) await loadFiles()
    })

    function updateHeader() {
      if (currentUser) {
        userBadge.textContent = `Signed in as ${currentUser.email}`
        userBadge.classList.remove('hidden')
        loginBtn.classList.add('hidden')
        logoutBtn.classList.remove('hidden')
      } else {
        userBadge.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        logoutBtn.classList.add('hidden')
      }
    }

    // Upload Files
    uploadBtn.addEventListener('click', async () => {
      const files = fileInput.files
      if (!currentUser) return alert('Please sign in first.')
      if (!files || !files.length) return alert('Choose file(s) first.')

      progressWrap.classList.remove('hidden')
      progressBar.style.width = '0%'
      progressText.textContent = `Uploading ${files.length} file(s)…`

      let uploaded = 0
      for (const f of files) {
        const path = `${currentUser.id}/${Date.now()}_${f.name}`
        console.log("Uploading to:", path)

        const { data, error: upErr } = await supabase.storage.from('health-records').upload(path, f)

        if (upErr) { 
          console.error("Upload failed:", upErr)
          alert("Upload error: " + upErr.message)
          continue 
        } else {
          console.log("Upload success:", data)
        }

        // Insert record in DB
        const { error: dbErr } = await supabase.from('files').insert({
          user_id: currentUser.id,
          name: f.name,
          size: f.size,
          path
        })
        if (dbErr) {
          console.error("DB Insert Error:", dbErr)
          alert("Database insert error: " + dbErr.message)
        }

        uploaded++
        const pct = Math.round((uploaded / files.length) * 100)
        progressBar.style.width = pct + '%'
        progressText.textContent = `Uploaded ${uploaded}/${files.length}`
      }

      fileInput.value = ''
      setTimeout(()=> progressWrap.classList.add('hidden'), 700)
      await loadFiles()
    })

    // Load Files
    async function loadFiles() {
      const { data, error } = await supabase
        .from('files')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })

      if (error) { console.error("Load error:", error); return }
      allFiles = data || []
      renderFiles(allFiles)
    }

    // Helpers
    function extToType(name) {
      const n = name.toLowerCase()
      if (n.endsWith('.pdf')) return 'pdf'
      if (n.endsWith('.jpg') || n.endsWith('.jpeg') || n.endsWith('.png') || n.endsWith('.webp')) return 'image'
      if (n.endsWith('.doc') || n.endsWith('.docx')) return 'doc'
      return 'other'
    }

    function fileIcon(type) {
      const base = 'display:inline-block;margin-right:8px;height:14px;width:14px;border-radius:3px;'
      if (type === 'pdf') return `<span style="${base}background:red"></span>`
      if (type === 'image') return `<span style="${base}background:green"></span>`
      if (type === 'doc') return `<span style="${base}background:blue"></span>`
      return `<span style="${base}background:gray"></span>`
    }

    function humanKB(bytes) {
      if (!bytes && bytes !== 0) return ''
      if (bytes < 1024) return `${bytes} B`
      const kb = bytes / 1024
      if (kb < 1024) return `${kb.toFixed(1)} KB`
      const mb = kb / 1024
      return `${mb.toFixed(1)} MB`
    }

    // Render
    function renderFiles(list) {
      const q = (searchInput.value || '').toLowerCase()
      const filter = typeFilter.value
      const filtered = list.filter(f => {
        const t = extToType(f.name)
        const byType = (filter === 'all') || (t === filter)
        const byQuery = f.name.toLowerCase().includes(q)
        return byType && byQuery
      })

      filesContainer.innerHTML = ''
      fileCount.textContent = `${filtered.length} file(s)`

      if (!filtered.length) {
        filesContainer.innerHTML = `<div style="padding:10px;color:#bbb;">No files found.</div>`
        return
      }

      for (const f of filtered) {
        const type = extToType(f.name)
        const row = document.createElement('div')
        row.className = 'file-card'
        row.innerHTML = `
          <div>
            ${fileIcon(type)}
            <strong>${f.name}</strong><br>
            <small>${humanKB(f.size)} • ${new Date(f.created_at).toLocaleString()}</small>
          </div>
          <div>
            <button class="btn-open btn" data-path="${f.path}">Open</button>
            <button class="btn-copy btn" data-path="${f.path}">Copy</button>
            <button class="btn-del btn" data-id="${f.id}" data-path="${f.path}">Delete</button>
          </div>
        `
        filesContainer.appendChild(row)
      }

      // Actions
      document.querySelectorAll('.btn-open').forEach(btn => btn.addEventListener('click', async (e) => {
        const path = e.currentTarget.getAttribute('data-path')
        const { data } = await supabase.storage.from('health-records').createSignedUrl(path, 3600)
        if (data?.signedUrl) window.open(data.signedUrl, '_blank')
      }))
      document.querySelectorAll('.btn-copy').forEach(btn => btn.addEventListener('click', async (e) => {
        const path = e.currentTarget.getAttribute('data-path')
        const { data } = await supabase.storage.from('health-records').createSignedUrl(path, 3600)
        if (data?.signedUrl) {
          await navigator.clipboard.writeText(data.signedUrl)
          alert('Share link copied (valid for 1 hour).')
        }
      }))
      document.querySelectorAll('.btn-del').forEach(btn => btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id')
        const path = e.currentTarget.getAttribute('data-path')
        if (!confirm('Delete this file?')) return

        await supabase.storage.from('health-records').remove([path])
        await supabase.from('files').delete().eq('id', id)

        allFiles = allFiles.filter(x => x.id !== id)
        renderFiles(allFiles)
      }))
    }

    // Filters
    searchInput.addEventListener('input', () => renderFiles(allFiles))
    typeFilter.addEventListener('change', () => renderFiles(allFiles))

    // Init session
    (async () => {
      const { data: { session } } = await supabase.auth.getSession()
      currentUser = session?.user || null
      updateHeader()
      if (currentUser) await loadFiles()
    })()
  </script>
</body>
</html>

