<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cloud Health Record Vault</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: { 50: '#f6f7f9', 100: '#eef0f4', 200: '#dfe3ea', 300: '#c9cfdb',
                   400: '#aab3c1', 500: '#8b97a8', 600: '#6b788a', 700: '#515d6e',
                   800: '#364253', 900: '#1f2b3a' },
            accent: { 500: '#0f62fe', 600: '#0b5adf', 700: '#0948ad' },
            success: { 600: '#0e8a00' },
            danger: { 600: '#da1e28' }
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.08)' },
          borderRadius: { xl2: '1.25rem' }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://esm.sh" />
</head>
<body class="min-h-screen bg-ink-50 text-ink-900">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-ink-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-lg bg-accent-500"></div>
        <h1 class="text-xl font-semibold">Cloud Health Record Vault</h1>
      </div>
      <div class="flex items-center gap-3">
        <span id="userBadge" class="hidden text-sm text-ink-700"></span>
        <button id="loginBtn" class="px-4 py-2 rounded-lg bg-ink-900 text-white hover:bg-ink-800">Sign in with Google</button>
        <button id="logoutBtn" class="hidden px-4 py-2 rounded-lg border border-ink-300 text-ink-800 hover:bg-ink-100">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Vault -->
  <main class="max-w-6xl mx-auto px-4 py-10 space-y-8">
    <!-- Upload Card -->
    <section class="rounded-xl2 shadow-soft bg-white border border-ink-100">
      <div class="p-5 border-b border-ink-100 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Upload health records</h3>
        <span id="quotaNote" class="text-xs text-ink-600">Free tier â€¢ Max 1GB</span>
      </div>
      <div class="p-5 space-y-4">
        <div class="flex flex-col md:flex-row md:items-center gap-3">
          <input id="fileInput" type="file" multiple class="block w-full text-sm text-ink-800 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-ink-900 file:text-white hover:file:bg-ink-800" />
          <button id="uploadBtn" class="px-4 py-2 rounded-lg bg-accent-500 text-white hover:bg-accent-600">Upload</button>
        </div>
        <div id="progressWrap" class="hidden">
          <div class="h-2 w-full bg-ink-100 rounded-full overflow-hidden">
            <div id="progressBar" class="h-2 bg-accent-500 w-0"></div>
          </div>
          <p id="progressText" class="mt-1 text-xs text-ink-700">Preparingâ€¦</p>
        </div>
      </div>
    </section>

    <!-- File List -->
    <section class="rounded-xl2 shadow-soft bg-white border border-ink-100">
      <div class="p-5 border-b border-ink-100 flex items-center justify-between">
        <h3 class="text-lg font-semibold">My files</h3>
        <span id="fileCount" class="text-sm text-ink-700"></span>
      </div>
      <div id="filesContainer" class="p-2 divide-y divide-ink-100"></div>
    </section>
  </main>

  <!-- Preview Modal -->
  <div id="previewModal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl2 shadow-soft max-w-3xl w-full max-h-[90vh] overflow-auto relative">
      <button id="closePreview" class="absolute top-3 right-3 bg-danger-600 text-white px-3 py-1 rounded">X</button>
      <div id="previewContent" class="p-6"></div>
    </div>
  </div>

  <!-- Supabase Script -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = "https://zmozpigwpfiibykixdjk.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptb3pwaWd3cGZpaWJ5a2l4ZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDg1NDAsImV4cCI6MjA3MDgyNDU0MH0.kgMCNatoRbIhnzTNF3TDuf_edrHOt4rVMcGnPtXPwFI"
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // UI refs
    const loginBtn = document.getElementById('loginBtn')
    const logoutBtn = document.getElementById('logoutBtn')
    const userBadge = document.getElementById('userBadge')
    const fileInput = document.getElementById('fileInput')
    const uploadBtn = document.getElementById('uploadBtn')
    const progressWrap = document.getElementById('progressWrap')
    const progressBar = document.getElementById('progressBar')
    const progressText = document.getElementById('progressText')
    const filesContainer = document.getElementById('filesContainer')
    const fileCount = document.getElementById('fileCount')
    const previewModal = document.getElementById('previewModal')
    const previewContent = document.getElementById('previewContent')
    const closePreview = document.getElementById('closePreview')

    let currentUser = null
    let allFiles = []

    // Auth
    loginBtn.addEventListener('click', async () => {
  await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: window.location.href }  // ðŸ‘ˆ stays on same page
  })
})

    logoutBtn.addEventListener('click', async () => { await supabase.auth.signOut(); location.reload() })

    supabase.auth.onAuthStateChange(async (_evt, session) => {
      currentUser = session?.user || null
      if (currentUser) { userBadge.textContent = currentUser.email; userBadge.classList.remove('hidden'); loginBtn.classList.add('hidden'); logoutBtn.classList.remove('hidden'); loadFiles() }
    })

    // Upload
    uploadBtn.addEventListener('click', async () => {
      const files = fileInput.files
      if (!files.length) return alert("Choose file(s)")
      progressWrap.classList.remove("hidden")
      let uploaded = 0
      for (const f of files) {
        const path = `${currentUser.id}/${Date.now()}_${f.name}`
        const { error } = await supabase.storage.from("health-records").upload(path, f)
        if (!error) {
          await supabase.from("files").insert({ user_id: currentUser.id, name: f.name, size: f.size, path })
          uploaded++
          const pct = Math.round((uploaded / files.length) * 100)
          progressBar.style.width = pct + "%"
          progressText.textContent = `Uploaded ${uploaded}/${files.length}`
        }
      }
      fileInput.value = ""
      setTimeout(()=> progressWrap.classList.add("hidden"), 600)
      loadFiles()
    })

    // Load + render
    async function loadFiles() {
      const { data } = await supabase.from("files").select("*").eq("user_id", currentUser.id).order("created_at", { ascending: false })
      allFiles = data || []
      fileCount.textContent = `${allFiles.length} file(s)`
      renderFiles()
    }

    function humanKB(bytes){ return (bytes/1024).toFixed(1)+" KB" }

    function renderFiles() {
      filesContainer.innerHTML = ""
      for (const f of allFiles) {
        const row = document.createElement("div")
        row.className = "flex items-center justify-between p-3 hover:bg-ink-50"
        row.innerHTML = `
          <div>
            <div class="font-medium">${f.name}</div>
            <div class="text-xs text-ink-600">${humanKB(f.size)}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn-open bg-accent-500 text-white px-3 py-1 rounded" data-path="${f.path}">Open</button>
            <button class="btn-copy border border-ink-300 px-3 py-1 rounded" data-path="${f.path}">Copy link</button>
            <button class="btn-prev bg-ink-900 text-white px-3 py-1 rounded" data-path="${f.path}">Preview</button>
            <button class="btn-del bg-danger-600 text-white px-3 py-1 rounded" data-id="${f.id}" data-path="${f.path}">Delete</button>
          </div>
        `
        filesContainer.appendChild(row)
      }

      // Wire buttons
      document.querySelectorAll(".btn-open").forEach(btn => btn.onclick = async e => {
        const { data } = await supabase.storage.from("health-records").createSignedUrl(e.target.dataset.path, 3600)
        if (data?.signedUrl) window.open(data.signedUrl, "_blank")
      })
      document.querySelectorAll(".btn-copy").forEach(btn => btn.onclick = async e => {
        const { data } = await supabase.storage.from("health-records").createSignedUrl(e.target.dataset.path, 3600)
        if (data?.signedUrl) { navigator.clipboard.writeText(data.signedUrl); alert("Link copied!") }
      })
      document.querySelectorAll(".btn-prev").forEach(btn => btn.onclick = async e => {
        const { data } = await supabase.storage.from("health-records").createSignedUrl(e.target.dataset.path, 3600)
        if (data?.signedUrl) {
          let content = ""
          if (e.target.dataset.path.endsWith(".jpg") || e.target.dataset.path.endsWith(".png")) {
            content = `<img src="${data.signedUrl}" class="max-h-[75vh] mx-auto rounded" />`
          } else if (e.target.dataset.path.endsWith(".pdf")) {
            content = `<iframe src="${data.signedUrl}" class="w-full h-[75vh]" frameborder="0"></iframe>`
          } else {
            content = `<p class="text-center text-ink-700">Preview not available for this file type.</p>`
          }
          previewContent.innerHTML = content
          previewModal.classList.remove("hidden")
        }
      })
      document.querySelectorAll(".btn-del").forEach(btn => btn.onclick = async e => {
        if (!confirm("Delete file?")) return
        await supabase.storage.from("health-records").remove([e.target.dataset.path])
        await supabase.from("files").delete().eq("id", e.target.dataset.id)
        loadFiles()
      })
    }

    closePreview.onclick = ()=> previewModal.classList.add("hidden")
  </script>
</body>
</html>
