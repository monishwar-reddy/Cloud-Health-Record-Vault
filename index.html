<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloud Health Record Vault</title>
  <link rel="icon" href="logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    /* Deloitte/IBM-ish palette + radii + shadows */
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: {
              50:'#f6f7f9',100:'#eef0f4',200:'#dfe3ea',300:'#c9cfdb',
              400:'#aab3c1',500:'#8b97a8',600:'#6b788a',700:'#515d6e',
              800:'#364253',900:'#1f2b3a'
            },
            accent: { 500:'#0f62fe',600:'#0b5adf',700:'#0948ad' },
            success:{600:'#0e8a00'}, danger:{600:'#da1e28'}
          },
          boxShadow:{ soft:'0 14px 40px rgba(0,0,0,.08)' },
          borderRadius:{ xl2:'1.25rem' },
          keyframes:{
            fadeUp:{ '0%':{opacity:0,transform:'translateY(12px)'},
                     '100%':{opacity:1,transform:'translateY(0)'} },
            floaty:{ '0%':{transform:'translateY(0)'},
                     '50%':{transform:'translateY(-6px)'},
                     '100%':{transform:'translateY(0)'} }
          },
          animation:{
            fadeUp:'fadeUp .5s ease-out both',
            floaty:'floaty 6s ease-in-out infinite'
          }
        }
      }
    }
  </script>
  <style>
    html { scroll-behavior: smooth; }
    /* soft hero gradient */
    .hero-bg {
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(15,98,254,.06), transparent 60%),
        radial-gradient(1000px 600px at 110% 0%, rgba(15,98,254,.05), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%);
    }
  </style>
</head>
<body class="min-h-screen bg-ink-50 text-ink-900">

  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-ink-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="#top" class="flex items-center gap-3 group">
        <!-- Replace logo.png in your repo to change the logo -->
        <img src="logo.png" alt="" class="h-9 w-9 rounded-lg ring-1 ring-ink-200 object-cover" onerror="this.style.display='none'">
        <div class="h-9 w-9 rounded-lg bg-accent-600 group-hover:bg-accent-700 transition hidden" id="logoFallback"></div>
        <div>
          <h1 class="text-xl font-semibold tracking-tight">Cloud Health Record Vault</h1>
          <p class="text-xs text-ink-600 -mt-0.5">Provider-agnostic â€¢ Patient self-access</p>
        </div>
      </a>
      <div class="flex items-center gap-3">
        <span id="userBadge" class="hidden text-sm text-ink-700"></span>
        <button id="loginBtn" class="px-4 py-2 rounded-lg bg-ink-900 text-white hover:bg-ink-800 transition">Sign in with Google</button>
        <button id="logoutBtn" class="hidden px-4 py-2 rounded-lg border border-ink-300 text-ink-800 hover:bg-ink-100 transition">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section id="top" class="relative hero-bg overflow-hidden">
    <div class="max-w-6xl mx-auto px-4 py-12 relative">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div class="animate-fadeUp">
          <h2 class="text-3xl md:text-4xl font-semibold leading-tight text-ink-900">
            Your health records, unified. Secure. Always available.
          </h2>
          <p class="mt-3 text-ink-700">
            Upload lab reports, prescriptions, scans, and share time-limited links with doctors. Built on Supabase free tier.
          </p>
          <div class="mt-5 flex gap-3">
            <a href="#vault" class="px-4 py-2 rounded-lg bg-accent-500 text-white hover:bg-accent-600 transition">Open Vault</a>
            <a href="#features" class="px-4 py-2 rounded-lg border border-ink-300 hover:bg-white transition">Learn more</a>
          </div>
        </div>
        <div class="rounded-xl2 shadow-soft bg-white p-5 border border-ink-100 animate-floaty">
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="p-4 rounded-xl border border-ink-100">
              <p class="text-xs text-ink-600">Storage</p>
              <p class="text-lg font-semibold">Private</p>
            </div>
            <div class="p-4 rounded-xl border border-ink-100">
              <p class="text-xs text-ink-600">Share Links</p>
              <p class="text-lg font-semibold">1 hour</p>
            </div>
            <div class="p-4 rounded-xl border border-ink-100">
              <p class="text-xs text-ink-600">Formats</p>
              <p class="text-lg font-semibold">PDF/JPG/DOCX</p>
            </div>
          </div>
          <!-- remove this whole block if you donâ€™t want the badges -->
        </div>
      </div>
    </div>
  </section>

  <!-- Vault -->
  <main id="vault" class="max-w-6xl mx-auto px-4 pb-16 space-y-8">
    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Upload Card -->
      <section class="lg:col-span-2 rounded-xl2 shadow-soft bg-white border border-ink-100 animate-fadeUp">
        <div class="p-5 border-b border-ink-100 flex items-center justify-between">
          <h3 class="text-lg font-semibold">Upload health records</h3>
          <span class="text-xs text-ink-600">Free tier â€¢ Keep under 1GB</span>
        </div>
        <div class="p-5 space-y-4">
          <div class="flex flex-col md:flex-row md:items-center gap-3">
            <input id="fileInput" type="file" multiple
              class="block w-full text-sm text-ink-800 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-ink-900 file:text-white hover:file:bg-ink-800" />
            <button id="uploadBtn"
              class="px-4 py-2 rounded-lg bg-accent-500 text-white hover:bg-accent-600 transition">Upload</button>
          </div>
          <div id="progressWrap" class="hidden">
            <div class="h-2 w-full bg-ink-100 rounded-full overflow-hidden">
              <div id="progressBar" class="h-2 bg-accent-500 w-0"></div>
            </div>
            <p id="progressText" class="mt-1 text-xs text-ink-700">Preparingâ€¦</p>
          </div>
        </div>
      </section>

      <!-- Filters / Info Card -->
      <aside class="rounded-xl2 shadow-soft bg-white border border-ink-100 p-5 space-y-4 animate-fadeUp">
        <h3 class="text-lg font-semibold">Find files</h3>
        <input id="searchInput" type="text" placeholder="Search by nameâ€¦"
          class="w-full rounded-lg border border-ink-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent-500" />
        <select id="typeFilter"
          class="w-full rounded-lg border border-ink-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent-500">
          <option value="all">All types</option>
          <option value="pdf">PDF</option>
          <option value="image">Images</option>
          <option value="doc">DOC/DOCX</option>
          <option value="other">Other</option>
        </select>
        <div class="text-xs text-ink-600">
          <p>â€¢ Files are private to your account.</p>
          <p>â€¢ Share links expire in 1 hour.</p>
        </div>
      </aside>
    </div>

    <!-- Files List -->
    <section class="rounded-xl2 shadow-soft bg-white border border-ink-100 animate-fadeUp">
      <div class="p-5 border-b border-ink-100 flex items-center justify-between">
        <h3 class="text-lg font-semibold">My files</h3>
        <span id="fileCount" class="text-sm text-ink-700"></span>
      </div>
      <div id="filesContainer" class="p-2 divide-y divide-ink-100"></div>
    </section>
  </main>

  <!-- Features (for the â€œLearn moreâ€ button) -->
  <section id="features" class="max-w-6xl mx-auto px-4 pb-20">
    <div class="grid md:grid-cols-3 gap-6">
      <div class="rounded-xl2 bg-white p-5 border border-ink-100 shadow-soft animate-fadeUp">
        <h4 class="font-semibold mb-2">Zero backend to run</h4>
        <p class="text-ink-700 text-sm">Auth, storage and DB handled by Supabase on the free tier.</p>
      </div>
      <div class="rounded-xl2 bg-white p-5 border border-ink-100 shadow-soft animate-fadeUp">
        <h4 class="font-semibold mb-2">Per-user isolation</h4>
        <p class="text-ink-700 text-sm">Objects are stored under your user ID; policies restrict access.</p>
      </div>
      <div class="rounded-xl2 bg-white p-5 border border-ink-100 shadow-soft animate-fadeUp">
        <h4 class="font-semibold mb-2">Time-limited links</h4>
        <p class="text-ink-700 text-sm">Create signed URLs that auto-expire (default 1 hour).</p>
      </div>
    </div>
  </section>

  <footer class="border-t border-ink-100 bg-white">
    <div class="max-w-6xl mx-auto px-4 py-8 text-xs text-ink-600">
      Built on Supabase free tier. Keep PHI safe: do not upload sensitive data unless your region and policies allow.
    </div>
  </footer>

  <!-- App Script -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    /* ðŸ”§ Replace with your keys */
    const SUPABASE_URL = 'https://zmozpigwpfiibykixdjk.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptb3pwaWd3cGZpaWJ5a2l4ZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDg1NDAsImV4cCI6MjA3MDgyNDU0MH0.kgMCNatoRbIhnzTNF3TDuf_edrHOt4rVMcGnPtXPwFI'
    const BUCKET = 'health-records'  // make sure this bucket exists

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // UI refs
    const loginBtn = document.getElementById('loginBtn')
    const logoutBtn = document.getElementById('logoutBtn')
    const userBadge = document.getElementById('userBadge')
    const fileInput = document.getElementById('fileInput')
    const uploadBtn = document.getElementById('uploadBtn')
    const progressWrap = document.getElementById('progressWrap')
    const progressBar = document.getElementById('progressBar')
    const progressText = document.getElementById('progressText')
    const filesContainer = document.getElementById('filesContainer')
    const fileCount = document.getElementById('fileCount')
    const searchInput = document.getElementById('searchInput')
    const typeFilter = document.getElementById('typeFilter')

    let currentUser = null
    let allFiles = []

    // Auth
    loginBtn.addEventListener('click', async () => {
      const redirectTo = window.location.origin + window.location.pathname
      await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo } })
    })
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut()
      currentUser = null
      updateHeader()
      renderFiles([])
    })
    supabase.auth.onAuthStateChange(async (_evt, session) => {
      currentUser = session?.user || null
      updateHeader()
      if (currentUser) await loadFiles()
    })
    function updateHeader() {
      if (currentUser) {
        userBadge.textContent = `Signed in as ${currentUser.email}`
        userBadge.classList.remove('hidden')
        loginBtn.classList.add('hidden')
        logoutBtn.classList.remove('hidden')
      } else {
        userBadge.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        logoutBtn.classList.add('hidden')
      }
    }

    // Upload
    uploadBtn.addEventListener('click', async () => {
      const files = fileInput.files
      if (!currentUser) return alert('Please sign in first.')
      if (!files || !files.length) return alert('Choose file(s) first.')

      progressWrap.classList.remove('hidden')
      progressBar.style.width = '0%'
      progressText.textContent = `Uploading ${files.length} file(s)â€¦`

      let uploaded = 0
      for (const f of files) {
        const path = `${currentUser.id}/${Date.now()}_${f.name}`
        const { error: upErr } = await supabase.storage.from(BUCKET).upload(path, f)
        if (upErr) { console.error(upErr); alert('Upload error: '+ upErr.message); continue }

        await supabase.from('files').insert({
          user_id: currentUser.id,
          name: f.name,
          size: f.size,
          path
        })

        uploaded++
        const pct = Math.round((uploaded / files.length) * 100)
        progressBar.style.width = pct + '%'
        progressText.textContent = `Uploaded ${uploaded}/${files.length}`
      }

      fileInput.value = ''
      setTimeout(()=> progressWrap.classList.add('hidden'), 500)
      await loadFiles()
    })

    // Load files
    async function loadFiles() {
      if (!currentUser) return
      const { data, error } = await supabase
        .from('files')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
      if (error) { console.error(error); return }
      allFiles = data || []
      renderFiles(allFiles)
    }

    // Helpers
    function extToType(name) {
      const n = name.toLowerCase()
      if (n.endsWith('.pdf')) return 'pdf'
      if (n.endsWith('.jpg') || n.endsWith('.jpeg') || n.endsWith('.png') || n.endsWith('.webp')) return 'image'
      if (n.endsWith('.doc') || n.endsWith('.docx')) return 'doc'
      return 'other'
    }
    function fileIcon(type) {
      const base = 'inline-block align-middle mr-2 h-5 w-5 rounded-sm'
      if (type === 'pdf') return `<span class="${base} bg-danger-600"></span>`
      if (type === 'image') return `<span class="${base} bg-accent-500"></span>`
      if (type === 'doc') return `<span class="${base} bg-ink-700"></span>`
      return `<span class="${base} bg-ink-300"></span>`
    }
    function humanKB(bytes) {
      if (!bytes && bytes !== 0) return ''
      if (bytes < 1024) return `${bytes} B`
      const kb = bytes / 1024
      if (kb < 1024) return `${kb.toFixed(1)} KB`
      const mb = kb / 1024
      return `${mb.toFixed(1)} MB`
    }

    // Render + actions (Open / Copy link / Delete)
    function renderFiles(list) {
      const q = (searchInput.value || '').toLowerCase()
      const filter = typeFilter.value
      const filtered = list.filter(f => {
        const t = extToType(f.name)
        const byType = (filter === 'all') || (t === filter)
        const byQuery = f.name.toLowerCase().includes(q)
        return byType && byQuery
      })

      filesContainer.innerHTML = ''
      fileCount.textContent = `${filtered.length} file(s)`

      if (!filtered.length) {
        filesContainer.innerHTML = `<div class="p-6 text-ink-600 text-sm">No files found.</div>`
        return
      }

      for (const f of filtered) {
        const type = extToType(f.name)
        const row = document.createElement('div')
        row.className = 'flex items-center justify-between p-3 hover:bg-ink-50'
        row.innerHTML = `
          <div class="flex items-center min-w-0">
            ${fileIcon(type)}
            <div class="min-w-0">
              <div class="font-medium truncate max-w-[52vw]">${f.name}</div>
              <div class="text-xs text-ink-600">${humanKB(f.size)} â€¢ ${new Date(f.created_at).toLocaleString()}</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn-open px-3 py-1.5 rounded-lg bg-ink-900 text-white text-sm hover:bg-ink-800 transition" data-path="${f.path}">Open</button>
            <button class="btn-copy px-3 py-1.5 rounded-lg border border-ink-300 text-sm hover:bg-ink-100 transition" data-path="${f.path}">Copy link</button>
            <button class="btn-del px-3 py-1.5 rounded-lg bg-danger-600 text-white text-sm hover:opacity-90 transition" data-id="${f.id}" data-path="${f.path}">Delete</button>
          </div>
        `
        filesContainer.appendChild(row)
      }

      // wire buttons
      document.querySelectorAll('.btn-open').forEach(btn => btn.onclick = async (e) => {
        const path = e.currentTarget.getAttribute('data-path')
        const { data, error } = await supabase.storage.from(BUCKET).createSignedUrl(path, 60*60)
        if (error) return alert(error.message)
        if (data?.signedUrl) window.open(data.signedUrl, '_blank')
      })
      document.querySelectorAll('.btn-copy').forEach(btn => btn.onclick = async (e) => {
        const path = e.currentTarget.getAttribute('data-path')
        const { data, error } = await supabase.storage.from(BUCKET).createSignedUrl(path, 60*60)
        if (error) return alert(error.message)
        if (data?.signedUrl) {
          await navigator.clipboard.writeText(data.signedUrl)
          alert('Share link copied (valid for 1 hour).')
        }
      })
      document.querySelectorAll('.btn-del').forEach(btn => btn.onclick = async (e) => {
        const id = e.currentTarget.getAttribute('data-id')
        const path = e.currentTarget.getAttribute('data-path')
        if (!confirm('Delete this file?')) return

        const { error: sErr } = await supabase.storage.from(BUCKET).remove([path])
        if (sErr) return alert('Delete failed (storage): ' + sErr.message)

        const { error: dErr } = await supabase.from('files').delete().eq('id', id)
        if (dErr) return alert('Delete failed (db): ' + dErr.message)

        allFiles = allFiles.filter(x => x.id !== id)
        renderFiles(allFiles)
      })
    }

    // search/filter
    searchInput.addEventListener('input', () => renderFiles(allFiles))
    typeFilter.addEventListener('change', () => renderFiles(allFiles))

    // boot
    (async () => {
      const { data: { session } } = await supabase.auth.getSession()
      currentUser = session?.user || null
      updateHeader()
      if (currentUser) await loadFiles()
      // show colored square if logo.png missing
      const logoImg = document.querySelector('img[src="logo.png"]')
      logoImg?.addEventListener('error', () => document.getElementById('logoFallback')?.classList.remove('hidden'))
    })()
  </script>
</body>
</html>
