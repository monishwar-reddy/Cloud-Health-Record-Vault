<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cloud Health Record Vault</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <link rel="stylesheet" href="style.css">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Cloud Health Record Vault</h1>
    
    <!-- Auth Buttons -->
    <div class="mb-4">
      <button id="loginBtn" class="px-4 py-2 bg-green-600 text-white rounded">Sign In with Google</button>
      <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded hidden">Sign Out</button>
      <p id="userInfo" class="mt-2 text-gray-700"></p>
    </div>

    <!-- Upload Section -->
    <div id="uploadSection" class="hidden bg-white p-4 rounded shadow mb-6">
      <input type="file" id="fileInput" class="mb-2">
      <button id="uploadBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Upload File</button>
    </div>

    <!-- File List -->
    <div id="fileList" class="bg-white p-4 rounded shadow hidden">
      <h2 class="text-xl font-semibold mb-3">My Files</h2>
      <div id="filesContainer" class="space-y-2"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    // Replace with your Supabase project details
    const SUPABASE_URL = 'https://zmozpigwpfiibykixdjk.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptb3pwaWd3cGZpaWJ5a2l4ZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDg1NDAsImV4cCI6MjA3MDgyNDU0MH0.kgMCNatoRbIhnzTNF3TDuf_edrHOt4rVMcGnPtXPwFI'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const loginBtn = document.getElementById('loginBtn')
    const logoutBtn = document.getElementById('logoutBtn')
    const uploadSection = document.getElementById('uploadSection')
    const fileInput = document.getElementById('fileInput')
    const uploadBtn = document.getElementById('uploadBtn')
    const userInfo = document.getElementById('userInfo')
    const fileList = document.getElementById('fileList')
    const filesContainer = document.getElementById('filesContainer')

    let currentUser = null

    // Sign in
    loginBtn.addEventListener('click', async () => {
      await supabase.auth.signInWithOAuth({ provider: 'google' })
    })

    // Sign out
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut()
      currentUser = null
      updateUI()
    })

    // Listen for auth state changes
    supabase.auth.onAuthStateChange(async (event, session) => {
      currentUser = session?.user || null
      updateUI()
      if (currentUser) {
        await loadFiles()
      }
    })

    // Update UI based on auth
    function updateUI() {
      if (currentUser) {
        loginBtn.classList.add('hidden')
        logoutBtn.classList.remove('hidden')
        uploadSection.classList.remove('hidden')
        fileList.classList.remove('hidden')
        userInfo.textContent = `Signed in as ${currentUser.email}`
      } else {
        loginBtn.classList.remove('hidden')
        logoutBtn.classList.add('hidden')
        uploadSection.classList.add('hidden')
        fileList.classList.add('hidden')
        userInfo.textContent = ''
      }
    }

    // Upload file
    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0]
      if (!file) {
        alert('Please select a file')
        return
      }
      const path = `${currentUser.id}/${Date.now()}_${file.name}`
      const { error: uploadError } = await supabase.storage.from('health-records').upload(path, file)
      if (uploadError) {
        alert('Upload failed: ' + uploadError.message)
        return
      }
      await supabase.from('files').insert([
        { user_id: currentUser.id, name: file.name, size: file.size, path }
      ])
      fileInput.value = ''
      await loadFiles()
      alert('File uploaded successfully!')
    })

    // Load files list
    async function loadFiles() {
      const { data, error } = await supabase.from('files').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false })
      if (error) {
        console.error(error)
        return
      }
      filesContainer.innerHTML = ''
      for (const f of data) {
        const { data: urlData } = await supabase.storage.from('health-records').createSignedUrl(f.path, 60 * 60)
        const div = document.createElement('div')
        div.className = 'flex justify-between items-center border p-2 rounded'
        div.innerHTML = `
          <div>
            <p class="font-medium">${f.name}</p>
            <p class="text-sm text-gray-500">${Math.round(f.size / 1024)} KB â€¢ ${new Date(f.created_at).toLocaleString()}</p>
          </div>
          <a href="${urlData.signedUrl}" target="_blank" class="px-3 py-1 bg-green-600 text-white rounded">Open</a>
        `
        filesContainer.appendChild(div)
      }
    }
  </script>
</body>
</html>
